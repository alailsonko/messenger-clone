# =============================================================================
# Docker Compose for Development with Sharding + PgBouncer
# =============================================================================
#
# 5-shard PostgreSQL cluster with streaming replication and PgBouncer pooling.
# PgBouncer is enabled by default for connection pooling.
#
# Architecture:
#   ┌────────────────────────────────────────────────────────────────────────────────┐
#   │                       API Server (Prefork with 7 CPU cores)                    │
#   │                   SHARDING_ENABLED=true :8080                                  │
#   └────────────────────────────────────────────────────────────────────────────────┘
#          │              │              │              │              │
#          ▼              ▼              ▼              ▼              ▼
#    ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
#    │PgBouncer │   │PgBouncer │   │PgBouncer │   │PgBouncer │   │PgBouncer │
#    │ Pool 0   │   │ Pool 1   │   │ Pool 2   │   │ Pool 3   │   │ Pool 4   │
#    │  :6430   │   │  :6431   │   │  :6432   │   │  :6433   │   │  :6434   │
#    └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘
#         │              │              │              │              │
#         ▼              ▼              ▼              ▼              ▼
#    ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
#    │ Shard 0  │   │ Shard 1  │   │ Shard 2  │   │ Shard 3  │   │ Shard 4  │
#    │ Primary  │   │ Primary  │   │ Primary  │   │ Primary  │   │ Primary  │
#    │  :5440   │   │  :5441   │   │  :5442   │   │  :5443   │   │  :5444   │
#    └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘
#         │              │              │              │              │
#         ▼              ▼              ▼              ▼              ▼
#    ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
#    │ Shard 0  │   │ Shard 1  │   │ Shard 2  │   │ Shard 3  │   │ Shard 4  │
#    │ Replica  │   │ Replica  │   │ Replica  │   │ Replica  │   │ Replica  │
#    │  :5450   │   │  :5451   │   │  :5452   │   │  :5453   │   │  :5454   │
#    └──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘
#
# Usage:
#   docker-compose up -d                    # Start shards + replicas + pgbouncer + redis
#   docker-compose --profile api up -d      # Include API server with hot reload
#   docker-compose --profile loadtest up -d # Include Gatling load test
#
# Ports:
#   API Server: 8080 (with prefork)
#   PgBouncer: 6430-6434 (connection poolers)
#   Primary shards: 5440-5444 (read/write)
#   Replica shards: 5450-5454 (read-only)
#   Redis: 6379
#
# =============================================================================

services:
  # ===========================================================================
  # API SERVER (Production with Prefork for multi-core performance)
  # ===========================================================================
  messenger_server:
    build:
      context: ./server
      target: production
    container_name: messenger_server
    hostname: messenger_server
    environment:
      - PORT=8080
      - SHARDING_ENABLED=true
      - SHARDING_COUNT=5
      - SHARDING_PER_SHARD_HOSTS=true
      # =====================================================================
      # Use PgBouncer for writes, direct shard replicas for reads
      # PgBouncer handles write pooling; replicas have lighter load
      # =====================================================================
      - SHARDING_BASE_HOST=pgbouncer
      - SHARDING_REPLICA_HOST=shard
      - SHARDING_BASE_PORT=5432
      - SHARDING_REPLICA_BASE_PORT=5432
      - DB_WRITE_USER=postgres
      - DB_WRITE_PASSWORD=postgres
      - DB_WRITE_NAME=messenger
      # =====================================================================
      # Connection Pool Tuning (per shard)
      # With PgBouncer, we can use more connections (PgBouncer multiplexes)
      # =====================================================================
      - DB_WRITE_MAX_OPEN_CONNS=500
      - DB_WRITE_MAX_IDLE_CONNS=250
      - DB_WRITE_CONN_MAX_LIFETIME=5
      # =====================================================================
      # Go Runtime Tuning
      # =====================================================================
      - GOGC=50
      - GOMEMLIMIT=4GiB
      # Number of prefork processes (one per CPU core for max throughput)
      - GOMAXPROCS=7
    deploy:
      resources:
        limits:
          cpus: '7'
          memory: 5G
        reservations:
          cpus: '6'
          memory: 4G
    ports:
      - "8080:8080"
    depends_on:
      pgbouncer-0:
        condition: service_healthy
      pgbouncer-1:
        condition: service_healthy
      pgbouncer-2:
        condition: service_healthy
      pgbouncer-3:
        condition: service_healthy
      pgbouncer-4:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      - sharded-network
    profiles:
      - api

  # ===========================================================================
  # SHARD 0 - PRIMARY
  # ===========================================================================
  shard-0:
    image: postgres:16-alpine
    container_name: shard-0
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
    ports:
      - "5440:5432"
    volumes:
      - shard0_data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 0 - REPLICA
  # ===========================================================================
  shard-0-replica:
    image: postgres:16-alpine
    container_name: shard-0-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
      PRIMARY_HOST: shard-0
      PRIMARY_PORT: 5432
      REPLICA_USER: replicator
      REPLICA_PASSWORD: replica_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5450:5432"
    volumes:
      - shard0_replica_data:/var/lib/postgresql/data
      - ./database/postgres/replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/replica-entrypoint.sh"]
    depends_on:
      shard-0:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 1 - PRIMARY
  # ===========================================================================
  shard-1:
    image: postgres:16-alpine
    container_name: shard-1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
    ports:
      - "5441:5432"
    volumes:
      - shard1_data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 1 - REPLICA
  # ===========================================================================
  shard-1-replica:
    image: postgres:16-alpine
    container_name: shard-1-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
      PRIMARY_HOST: shard-1
      PRIMARY_PORT: 5432
      REPLICA_USER: replicator
      REPLICA_PASSWORD: replica_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5451:5432"
    volumes:
      - shard1_replica_data:/var/lib/postgresql/data
      - ./database/postgres/replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/replica-entrypoint.sh"]
    depends_on:
      shard-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 2 - PRIMARY
  # ===========================================================================
  shard-2:
    image: postgres:16-alpine
    container_name: shard-2
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
    ports:
      - "5442:5432"
    volumes:
      - shard2_data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 2 - REPLICA
  # ===========================================================================
  shard-2-replica:
    image: postgres:16-alpine
    container_name: shard-2-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
      PRIMARY_HOST: shard-2
      PRIMARY_PORT: 5432
      REPLICA_USER: replicator
      REPLICA_PASSWORD: replica_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5452:5432"
    volumes:
      - shard2_replica_data:/var/lib/postgresql/data
      - ./database/postgres/replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/replica-entrypoint.sh"]
    depends_on:
      shard-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 3 - PRIMARY
  # ===========================================================================
  shard-3:
    image: postgres:16-alpine
    container_name: shard-3
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
    ports:
      - "5443:5432"
    volumes:
      - shard3_data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 3 - REPLICA
  # ===========================================================================
  shard-3-replica:
    image: postgres:16-alpine
    container_name: shard-3-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
      PRIMARY_HOST: shard-3
      PRIMARY_PORT: 5432
      REPLICA_USER: replicator
      REPLICA_PASSWORD: replica_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5453:5432"
    volumes:
      - shard3_replica_data:/var/lib/postgresql/data
      - ./database/postgres/replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/replica-entrypoint.sh"]
    depends_on:
      shard-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # PGBOUNCER 0 - Connection pooler for Shard 0
  # ===========================================================================
  pgbouncer-0:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: pgbouncer-0
    environment:
      DB_HOST: shard-0
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 10000
      DEFAULT_POOL_SIZE: 200
      MIN_POOL_SIZE: 50
      MAX_DB_CONNECTIONS: 300
      RESERVE_POOL_SIZE: 50
      RESERVE_POOL_TIMEOUT: 3
      AUTH_TYPE: md5
    ports:
      - "6430:5432"
    depends_on:
      shard-0:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # PGBOUNCER 1 - Connection pooler for Shard 1
  # ===========================================================================
  pgbouncer-1:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: pgbouncer-1
    environment:
      DB_HOST: shard-1
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 10000
      DEFAULT_POOL_SIZE: 200
      MIN_POOL_SIZE: 50
      MAX_DB_CONNECTIONS: 300
      RESERVE_POOL_SIZE: 50
      RESERVE_POOL_TIMEOUT: 3
      AUTH_TYPE: md5
    ports:
      - "6431:5432"
    depends_on:
      shard-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # PGBOUNCER 2 - Connection pooler for Shard 2
  # ===========================================================================
  pgbouncer-2:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: pgbouncer-2
    environment:
      DB_HOST: shard-2
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 10000
      DEFAULT_POOL_SIZE: 200
      MIN_POOL_SIZE: 50
      MAX_DB_CONNECTIONS: 300
      RESERVE_POOL_SIZE: 50
      RESERVE_POOL_TIMEOUT: 3
      AUTH_TYPE: md5
    ports:
      - "6432:5432"
    depends_on:
      shard-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # PGBOUNCER 3 - Connection pooler for Shard 3
  # ===========================================================================
  pgbouncer-3:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: pgbouncer-3
    environment:
      DB_HOST: shard-3
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 10000
      DEFAULT_POOL_SIZE: 200
      MIN_POOL_SIZE: 50
      MAX_DB_CONNECTIONS: 300
      RESERVE_POOL_SIZE: 50
      RESERVE_POOL_TIMEOUT: 3
      AUTH_TYPE: md5
    ports:
      - "6433:5432"
    depends_on:
      shard-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 4 - PRIMARY
  # ===========================================================================
  shard-4:
    image: postgres:16-alpine
    container_name: shard-4
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
    ports:
      - "5444:5432"
    volumes:
      - shard4_data:/var/lib/postgresql/data
      - ./database/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # SHARD 4 - REPLICA
  # ===========================================================================
  shard-4-replica:
    image: postgres:16-alpine
    container_name: shard-4-replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messenger
      PRIMARY_HOST: shard-4
      PRIMARY_PORT: 5432
      REPLICA_USER: replicator
      REPLICA_PASSWORD: replica_password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5454:5432"
    volumes:
      - shard4_replica_data:/var/lib/postgresql/data
      - ./database/postgres/replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/replica-entrypoint.sh"]
    depends_on:
      shard-4:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d messenger"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # PGBOUNCER 4 - Connection pooler for Shard 4
  # ===========================================================================
  pgbouncer-4:
    image: edoburu/pgbouncer:1.21.0-p0
    container_name: pgbouncer-4
    environment:
      DB_HOST: shard-4
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 10000
      DEFAULT_POOL_SIZE: 200
      MIN_POOL_SIZE: 50
      MAX_DB_CONNECTIONS: 300
      RESERVE_POOL_SIZE: 50
      RESERVE_POOL_TIMEOUT: 3
      AUTH_TYPE: md5
    ports:
      - "6434:5432"
    depends_on:
      shard-4:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - sharded-network

  # ===========================================================================
  # Redis (for caching)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - sharded-network

  # ===========================================================================
  # Load Testing Service (Gatling)
  # ===========================================================================
  loadtest:
    build:
      context: ./loadtest/gatling
    container_name: messenger_loadtest
    environment:
      - BASE_URL=${LOADTEST_BASE_URL:-http://host.docker.internal:8080}
      - TEST_TYPE=${LOADTEST_TYPE:-load}
      - SIMULATION=${LOADTEST_SIMULATION:-messenger.CreateUserSimulation}
      - TARGET_USERS=${LOADTEST_USERS:-100}
      - TEST_DURATION=${LOADTEST_DURATION:-60}
      - RAMP_DURATION=${LOADTEST_RAMP:-30}
      - REQUESTS_PER_SECOND=${LOADTEST_RPS:-1000}
    volumes:
      - ./loadtest/gatling/results:/results
    networks:
      - sharded-network
    profiles:
      - loadtest

# =============================================================================
# Volumes
# =============================================================================
volumes:
  shard0_data:
  shard0_replica_data:
  shard1_data:
  shard1_replica_data:
  shard2_data:
  shard2_replica_data:
  shard3_data:
  shard3_replica_data:
  shard4_data:
  shard4_replica_data:

# =============================================================================
# Networks
# =============================================================================
networks:
  sharded-network:
    driver: bridge
